<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Playground v18 ‚Äî Beginner + History + Download</title>

<!-- CodeMirror Syntax Highlight -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
:root{--bg:#020617;--panel:#020617;--text:#e5e7eb;--accent:#2563eb;--console-bg:#000}
body{margin:0;background:var(--bg);color:var(--text);font-family:monospace;display:flex;justify-content:center;padding:10px;min-height:100vh}
.app{width:100%;max-width:900px;background:var(--panel);border-radius:12px;padding:12px}
.file-tabs{display:flex;gap:6px;overflow-x:auto;margin-bottom:8px}
.file-btn{padding:8px 12px;background:#334155;border-radius:8px;cursor:pointer}
.file-btn.active{background:var(--accent)}
.buttons{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
button{flex:1;padding:10px;border:none;border-radius:8px;background:var(--accent);color:white;cursor:pointer}
.panel-tabs{display:flex;gap:6px;margin-top:10px}
.panel-btn{padding:6px 10px;background:#334155;border-radius:6px;cursor:pointer}
.panel-btn.active{background:var(--accent)}
.panel{margin-top:8px;background:var(--console-bg);padding:12px;border-radius:10px;height:200px;overflow-y:auto;font-size:14px;display:none}
.panel.active{display:block}
.error{color:red}.log{color:white}
#previewArea{display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:white;z-index:9999}
#previewFrame{width:100%;height:calc(100vh - 50px);border:none}
#historyBox{display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000b;z-index:9999;padding:10px;overflow:auto}
#historyInner{background:#111;padding:10px;border-radius:10px;max-width:700px;margin:auto;margin-top:30px}
.history-item{padding:6px;margin:4px 0;background:#222;border-radius:6px;display:flex;justify-content:space-between}

/* === mobile copy-paste fix === */
.CodeMirror{
  -webkit-user-modify: read-write-plaintext-only;
  user-select:text;
}
.cm-fat-cursor { caret-color:white; }
</style>
</head>

<body>
<div class="app" id="editorArea">
<h2>Playground v18 ‚Äî HTML / CSS / JS</h2>

<div class="file-tabs">
<div class="file-btn active" onclick="switchFile('index.html')">index.html</div>
<div class="file-btn" onclick="switchFile('style.css')">style.css</div>
<div class="file-btn" onclick="switchFile('script.js')">script.js</div>
</div>

<textarea id="editor"></textarea>

<div class="buttons">
<button onclick="runJS()">‚ñ∂ Run JS</button>
<button onclick="showPreviewFull()">üåê Preview</button>
<button onclick="showConsoleFull()">üñ• Console</button>
<button onclick="openHistory()">üìú History</button>
<button onclick="downloadZip()">üì¶ Download ZIP</button>
</div>

<div class="panel-tabs">
<div class="panel-btn active" onclick="showPanel('jsPanel')">JS console</div>
</div>

<div id="jsPanel" class="panel active"></div>
</div>

<div id="previewArea">
<button onclick="hidePreview()" style="width:100%;">üîô Back</button>
<iframe id="previewFrame"></iframe>
</div>

<div id="consoleFull" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:black;color:white;z-index:9999">
<button onclick="hideConsoleFull()">üîô Back</button>
<pre id="consoleFullContent"></pre>
</div>

<div id="historyBox"><div id="historyInner"></div></div>

<script>
let files=JSON.parse(localStorage.getItem("files_v18")||"{}")
let hist=JSON.parse(localStorage.getItem("hist_v18")||"[]")

if(Object.keys(files).length===0){
files={"index.html":"<h1>Hello!</h1>","style.css":"body{background:white;}","script.js":"console.log('JS OK')"}
}

function save(){localStorage.setItem("files_v18",JSON.stringify(files))}
function saveHist(){localStorage.setItem("hist_v18",JSON.stringify(hist))}

let current="index.html"
let cm

function setup(){
cm=CodeMirror.fromTextArea(document.getElementById("editor"),{
  mode:"xml",
  theme:"dracula",
  lineNumbers:true,
  lineWrapping:true,
  inputStyle:"textarea"   /* <-- MOST IMPORTANT FIX */
})
cm.setValue(files[current])
cm.on("change",()=>{files[current]=cm.getValue();save()})
}
setup()

function switchFile(n){
files[current]=cm.getValue();current=n
cm.setOption("mode",current.endsWith(".js")?"javascript":current.endsWith(".css")?"css":"xml")
cm.setValue(files[current])
document.querySelectorAll(".file-btn").forEach(b=>b.classList.remove("active"))
;[...document.querySelectorAll(".file-btn")].find(b=>b.innerText.includes(n)).classList.add("active")
}

function showPanel(id){document.getElementById("jsPanel").classList.add("active")}

function runJS(){
let p=document.getElementById("jsPanel");p.innerHTML=""
try{let r=eval(files["script.js"]);if(r!==undefined)p.innerHTML+=`<div class="log">${r}</div>`}
catch(e){p.innerHTML=`<div class="error">${e.message}</div>`}
hist.push({t:new Date().toLocaleString(),snap:JSON.stringify(files)});saveHist()
}

function showPreviewFull(){
let f=document.getElementById("previewFrame")
f.srcdoc=`<html><head><style>${files["style.css"]}</style></head><body>${files["index.html"]}<script>try{${files["script.js"]}}catch(e){document.body.innerHTML+='<pre style="color:red">'+e+'</pre>'}<\/script></body></html>`
document.getElementById("previewArea").style.display="block"
document.getElementById("editorArea").style.display="none"
}
function hidePreview(){
document.getElementById("previewArea").style.display="none"
document.getElementById("editorArea").style.display="block"
}

function showConsoleFull(){
document.getElementById("consoleFullContent").innerText=document.getElementById("jsPanel").innerText
document.getElementById("consoleFull").style.display="block"
}
function hideConsoleFull(){
document.getElementById("consoleFull").style.display="none"
}

function openHistory(){
let box=document.getElementById("historyInner");box.innerHTML="<h3>History</h3>"
hist.forEach((h,i)=>{box.innerHTML+=`<div class='history-item'><span>${h.t}</span><button onclick='restore(${i})'>Restore</button></div>`})
document.getElementById("historyBox").style.display="block"
}
function restore(i){
files=JSON.parse(hist[i].snap);save();cm.setValue(files[current]);alert("Restored")
}

function downloadZip(){
let z=new JSZip()
Object.keys(files).forEach(n=>z.file(n,files[n]))
z.generateAsync({type:"blob"}).then(c=>{
let a=document.createElement("a")
a.href=URL.createObjectURL(c);a.download="project.zip";a.click()
})
}
document.getElementById("historyBox").onclick=e=>{if(e.target.id==="historyBox")e.target.style.display="none"}
</script>
</body>
</html>
